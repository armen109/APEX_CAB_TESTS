name: Regression Tests

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'regression'
        type: choice
        options:
          - regression
          - login
          - register
          - profile
          - settings

jobs:
  regression-tests:
    name: Run Regression Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js (if needed for scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Maestro (if not pre-installed)
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
      
      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          # Login Credentials
          LOGIN_VALID_PHONE=${{ secrets.LOGIN_VALID_PHONE }}
          LOGIN_VALID_OTP=${{ secrets.LOGIN_VALID_OTP }}
          LOGIN_INVALID_PHONE=${{ secrets.LOGIN_INVALID_PHONE }}
          LOGIN_NOT_REGISTERED_PHONE=${{ secrets.LOGIN_NOT_REGISTERED_PHONE }}
          LOGIN_INCORRECT_OTP=${{ secrets.LOGIN_INCORRECT_OTP }}
          LOGIN_VALID_EMAIL=${{ secrets.LOGIN_VALID_EMAIL }}
          LOGIN_INVALID_EMAIL=${{ secrets.LOGIN_INVALID_EMAIL }}
          LOGIN_NOT_REGISTERED_EMAIL=${{ secrets.LOGIN_NOT_REGISTERED_EMAIL }}
          
          # Profile Credentials
          PROFILE_VALID_EMAIL=${{ secrets.PROFILE_VALID_EMAIL }}
          PROFILE_VALID_PHONE=${{ secrets.PROFILE_VALID_PHONE }}
          PROFILE_VALID_OTP=${{ secrets.PROFILE_VALID_OTP }}
          PROFILE_ALREADY_REGISTERED_PHONE=${{ secrets.PROFILE_ALREADY_REGISTERED_PHONE }}
          PROFILE_INVALID_PHONE=${{ secrets.PROFILE_INVALID_PHONE }}
          PROFILE_VALID_NAME=${{ secrets.PROFILE_VALID_NAME }}
          PROFILE_INVALID_NAME=${{ secrets.PROFILE_INVALID_NAME }}
          
          # Registration Credentials
          REGISTRATION_INVALID_PHONE=${{ secrets.REGISTRATION_INVALID_PHONE }}
          REGISTRATION_INVALID_EMAIL=${{ secrets.REGISTRATION_INVALID_EMAIL }}
          REGISTRATION_VALID_PHONE=${{ secrets.REGISTRATION_VALID_PHONE }}
          REGISTRATION_INCORRECT_OTP=${{ secrets.REGISTRATION_INCORRECT_OTP }}
          REGISTRATION_ALREADY_REGISTERED_EMAIL=${{ secrets.REGISTRATION_ALREADY_REGISTERED_EMAIL }}
          REGISTRATION_ALREADY_REGISTERED_PHONE=${{ secrets.REGISTRATION_ALREADY_REGISTERED_PHONE }}
          
          # Ride Requests Credentials
          RIDE_REQUESTS_TESTING_PICK_UP=${{ secrets.RIDE_REQUESTS_TESTING_PICK_UP }}
          RIDE_REQUESTS_TESTING_PICK_UP2=${{ secrets.RIDE_REQUESTS_TESTING_PICK_UP2 }}
          RIDE_REQUESTS_TESTING_DESTINATION=${{ secrets.RIDE_REQUESTS_TESTING_DESTINATION }}
          RIDE_REQUESTS_NOT_SUPPORTED_LOCATION=${{ secrets.RIDE_REQUESTS_NOT_SUPPORTED_LOCATION }}
          RIDE_REQUESTS_BOOKING_RIDER_NAME=${{ secrets.RIDE_REQUESTS_BOOKING_RIDER_NAME }}
          RIDE_REQUESTS_BOOKING_RIDER_PHONE=${{ secrets.RIDE_REQUESTS_BOOKING_RIDER_PHONE }}
          EOF
        shell: bash
      
      - name: Run Regression Tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          # Note: Makefile uses Windows commands, so we run tests directly
          # For Linux CI/CD, you may need to adapt the Makefile or run tests directly
          # For now, we'll use maestro directly
          maestro test flows/Activity/*.yaml || true
          maestro test flows/Login/*.yaml || true
          maestro test flows/LogOut/*.yaml || true
          maestro test flows/Profile/Email/already-registered-email-change.yaml || true
          maestro test flows/Profile/Email/invalid-email-change.yaml || true
          maestro test flows/Profile/Name/*.yaml || true
          maestro test flows/Profile/PhoneNumber/*.yaml || true
          maestro test flows/Profile/ProfilePhoto/*.yaml || true
          maestro test flows/Register/*.yaml || true
          maestro test flows/Settings/**/*.yaml || true
        continue-on-error: true
        env:
          # Pass environment variables to the test runner
          LOGIN_VALID_PHONE: ${{ secrets.LOGIN_VALID_PHONE }}
          LOGIN_VALID_OTP: ${{ secrets.LOGIN_VALID_OTP }}
          LOGIN_INVALID_PHONE: ${{ secrets.LOGIN_INVALID_PHONE }}
          LOGIN_NOT_REGISTERED_PHONE: ${{ secrets.LOGIN_NOT_REGISTERED_PHONE }}
          LOGIN_INCORRECT_OTP: ${{ secrets.LOGIN_INCORRECT_OTP }}
          LOGIN_VALID_EMAIL: ${{ secrets.LOGIN_VALID_EMAIL }}
          LOGIN_INVALID_EMAIL: ${{ secrets.LOGIN_INVALID_EMAIL }}
          LOGIN_NOT_REGISTERED_EMAIL: ${{ secrets.LOGIN_NOT_REGISTERED_EMAIL }}
          PROFILE_VALID_EMAIL: ${{ secrets.PROFILE_VALID_EMAIL }}
          PROFILE_VALID_PHONE: ${{ secrets.PROFILE_VALID_PHONE }}
          PROFILE_VALID_OTP: ${{ secrets.PROFILE_VALID_OTP }}
          PROFILE_ALREADY_REGISTERED_PHONE: ${{ secrets.PROFILE_ALREADY_REGISTERED_PHONE }}
          PROFILE_INVALID_PHONE: ${{ secrets.PROFILE_INVALID_PHONE }}
          PROFILE_VALID_NAME: ${{ secrets.PROFILE_VALID_NAME }}
          PROFILE_INVALID_NAME: ${{ secrets.PROFILE_INVALID_NAME }}
          REGISTRATION_INVALID_PHONE: ${{ secrets.REGISTRATION_INVALID_PHONE }}
          REGISTRATION_INVALID_EMAIL: ${{ secrets.REGISTRATION_INVALID_EMAIL }}
          REGISTRATION_VALID_PHONE: ${{ secrets.REGISTRATION_VALID_PHONE }}
          REGISTRATION_INCORRECT_OTP: ${{ secrets.REGISTRATION_INCORRECT_OTP }}
          REGISTRATION_ALREADY_REGISTERED_EMAIL: ${{ secrets.REGISTRATION_ALREADY_REGISTERED_EMAIL }}
          REGISTRATION_ALREADY_REGISTERED_PHONE: ${{ secrets.REGISTRATION_ALREADY_REGISTERED_PHONE }}
          RIDE_REQUESTS_TESTING_PICK_UP: ${{ secrets.RIDE_REQUESTS_TESTING_PICK_UP }}
          RIDE_REQUESTS_TESTING_PICK_UP2: ${{ secrets.RIDE_REQUESTS_TESTING_PICK_UP2 }}
          RIDE_REQUESTS_TESTING_DESTINATION: ${{ secrets.RIDE_REQUESTS_TESTING_DESTINATION }}
          RIDE_REQUESTS_NOT_SUPPORTED_LOCATION: ${{ secrets.RIDE_REQUESTS_NOT_SUPPORTED_LOCATION }}
          RIDE_REQUESTS_BOOKING_RIDER_NAME: ${{ secrets.RIDE_REQUESTS_BOOKING_RIDER_NAME }}
          RIDE_REQUESTS_BOOKING_RIDER_PHONE: ${{ secrets.RIDE_REQUESTS_BOOKING_RIDER_PHONE }}
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/
          retention-days: 30
      
      - name: Upload test summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: reports/*.txt
          retention-days: 30

